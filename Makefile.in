OBJ=crawler.o rdup.o gfunc.o getdelim.o signal.o
HDR=rdup.h 
CMD=rdup 
SHS_IN=mirror.sh hist.sh yesterday.sh crypt.sh gzip.sh dump.sh purge.sh dump-here.sh grep.sh
RES_IN=rorrim.sh monthday.sh
MAN8_IN=rdup.8 mirror.sh.8 dump.sh.8 purge.sh.8 dump-here.sh.8 monthday.sh.8 rorrim.sh.8
MAN1_IN=hist.sh.1 yesterday.sh.1 crypt.sh.1 gzip.sh.1 grep.sh.1

SHS=$(addprefix sh-tools/, $(SHS_IN))
RES=$(addprefix sh-restore/, $(RES_IN))
MAN8=$(addprefix doc/, $(MAN8_IN))
MAN1=$(addprefix doc/, $(MAN1_IN))

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
sbindir=@sbindir@
mandir=@mandir@
sysconfdir=@sysconfdir@

GCC=@CC@
GLIB_CFLAGS=@GLIB_CFLAGS@
GLIB_LIBS=@GLIB_LIBS@
CFLAGS=-Wall -W -Werror @CFLAGS@ @DEFS@ -Os -D_FILE_OFFSET_BITS=64 -D_LARGE_FILES -Wpointer-arith -Wstrict-prototypes
INSTALL=./install-sh -c
INSTALL_DATA=$(INSTALL) -m 644

.PHONY:	all clean install all uninstall

%.o:    %.c ${HDR}
	${GCC} ${CFLAGS} ${GLIB_CFLAGS} -c $<

all:	rdup scripts

rdup:	${OBJ} ${HDR} 
	${GCC} ${GLIB_LIBS} ${OBJ} -o rdup
	strip rdup

scripts:
	chmod +x $(SHS) $(RES)

clean:
	rm -f *.o
	rm -f rdup

realclean: clean
	rm -rf autom4te.cache
	rm -f config.log
	rm -f config.status
	rm -f config.h
	rm -f rdup.h
	rm -f rdup*.tar.bz2
	rm -f rdup*.tar.bz2.sha1
	rm -f ${MAN1} ${MAN8}

distclean: realclean
	rm -f configure
	rm -f Makefile
	rm -f *.tar.bz2
	rm -f *.tar.gz

install: rdup 
	mkdir -p ${DESTDIR}${sysconfdir}/rdup
	mkdir -p ${DESTDIR}${mandir}/man1
	mkdir -p ${DESTDIR}${mandir}/man8
	for i in ${CMD}; do ${INSTALL} $$i ${DESTDIR}${sbindir}/$$i ; done
	for i in ${SHS}; do ${INSTALL} $$i ${DESTDIR}${sbindir}/`basename $$i` ; done
	for i in ${MAN8}; do ${INSTALL_DATA} $$i ${DESTDIR}${mandir}/man8/`basename $$i` ; done
	for i in ${MAN1}; do ${INSTALL_DATA} $$i ${DESTDIR}${mandir}/man1/`basename $$i` ; done

uninstall:
	for i in ${CMD}; do rm -f ${DESTDIR}${sbindir}/$$i ; done
	for i in ${SHS}; do rm -f ${DESTDIR}${sbindir}/`basename $$i` ; done
	for i in ${MAN8}; do rm -f ${DESTDIR}${mandir}/man8/`basename $$i` ; done
	for i in ${MAN1}; do rm -f  ${DESTDIR}${mandir}/man1/`basename $$i` ; done
