#!/bin/sh

# create a hardlinked backup
# this scripts figures out if the
# dump is incremental or full

prefix=@prefix@
exec_prefix=@exec_prefix@
datadir=@datadir@/rdup
sysconfdir=@sysconfdir@/rdup

# shared stuff
source $datadir/shared.sh

usage() {
        echo "$PROGNAME -b DIR [OPTIONS] DIR [DIR ...]"
        echo
        echo "This is a wrapper around rdup and snap.pl"
        echo
        echo DIR \ - directories to back up
        echo
        echo OPTIONS:
        echo " -b DIR     backup directory"
        echo " -c REMOTE  dump the backup on a remote machine with ssh (not yet)"
        echo " -k KEYFILE encrypt all files, using crypt.pl"
        echo " -z         compress all files, using gzip.pl"
        echo " -a         write extended attributes with uid/gid"
        echo " -e         filelist and timestamp are put in backup directory (not yet)."
        echo " -v         echo the files processed to stderr"
        echo " -x         pass -x to rdup"
        echo " -h         this help"
        echo " -V         print version"
}

# better check what to copy
what() {
        if [[ -d $BACKUPDIR/$NOW ]]; then
                # already there do not link
                return 0
        fi

        for i in `seq 1 7`; do
                dir=`date +%Y%m/%d --date "$i days ago"`
                if [[ -d $BACKUPDIR/$dir ]]; then
                        # copy 'em over
                        _echo2 "Linking dir: \`$dir'"
                        cp -plr $BACKUPDIR/$dir $BACKUPDIR/$NOW
                        return 0
                fi
        done
        return 1
}

PROGNAME=$0
NOW=`date +%Y%m/%d`
OPT=""
R_OPT="-l"
ETC="@sysconfdir@/rdup"
pipe=""

while getopts ":ab:k:c:vzxhV" o; do
        case $o in
                b) BACKUPDIR="$OPTARG"
                if [[ -z "$OPTARG" ]]; then
                        _echo2 "-b needs an argument"
                        exit 1
                fi
                ;;
                k)
                if [[ -z "$OPTARG" ]]; then
                        _echo2 "-k needs an argument"
                        exit 1
                fi
                if [[ ! -r "$OPTARG" ]]; then
                        _echo2 "Cannot read keyfile \`$OPTARG': failed"
                        exit 1
                fi
                pipe="$pipe | @sbindir@/rdup-crypt $OPTARG"
                ;;
                z) pipe="$pipe | @sbindir@/rdup-gzip";;
                a) OPT="$OPT -a";;
                v) OPT="$OPT -v";;
                x) R_OPT="$R_OPT -x";;
                h) usage && exit;;
                V) version && exit;;
        esac
done
shift $((OPTIND - 1))
if [[ $# -eq 0 ]]; then
        _echo2 "No directories to backup"
        exit 1
fi

STAMP="$ETC/$HOSTNAME.$(basename $1).timestamp"
LIST="$ETC/$HOSTNAME.$(basename $1).list"

# create our command line 
pipe="$pipe | @sbindir@/rdup-snap $OPT -b $BACKUPDIR/$NOW"
cmd="@sbindir@/rdup $R_OPT -N $STAMP $LIST $@ $pipe"

mkdir -p $BACKUPDIR
if [[ ! $? ]]; then
        _echo2 "Can not create backup directory"
        exit 1
fi

what; purpose=$? # save return code from what
case $purpose in
        0)
        _echo2 "INCREMENTAL DUMP"
        ;;
        1)
        _echo2 "FULL DUMP"
        rm -f $LIST
        rm -f $STAMP
        ;;
esac
# execute the backup command
eval ${cmd}
chmod 755 $BACKUPDIR/$NOW               # hmmm
exit 0
