#!/usr/bin/perl -w
#
# Copyright (c) 2005, 2006 Miek Gieben; Mark J Hewitt
# See LICENSE for the license
#
# grep rdup output
#
use strict;

use Getopt::Std;
use File::Basename;
use File::Temp qw{tempdir tempfile};
use File::Spec;

my $S_MMASK = 07777;      # mask to get permission
my $S_ISDIR = 040000;
my $S_ISLNK = 0120000;

my $progName = basename $0;

my %opt;
my ($remote, $verbose, $invert);

getopts('cihvV', \%opt);
usage() if $opt{'h'};
version() if $opt{'V'};
$verbose = $opt{'v'};
$remote = $opt{'c'};
$invert = $opt{'i'};
my ($mode, $uid, $gid, $psize, $fsize, $path);
my $REG = $ARGV[0];

if (defined($ARGV[0])) {
        $REG = $ARGV[0];
} else {
        die "** Need an regular expression";
}

if ($remote) {
        while (($_ = <STDIN>)) {
                chomp;
                ($mode, $uid, $gid, $psize, $fsize) = split(" ", $_, 5);
                _grep();
        }
} else {
        while (($_ = <STDIN>)) {
                chomp;
                ($mode, $uid, $gid, $psize, $fsize, $path) = split(" ", $_, 6);
                _grep();
        }
}
exit 0;

sub _grep {
        my $dump = substr($mode, 0, 1);
        my $modebits = substr($mode, 1);

        sanity_check($dump, $modebits, $psize, $fsize, $uid, $gid);

        if ($remote) {
                $path = "";
                read STDIN, $path, $psize;
        }

        if ($path eq "") {
                die "** Empty path";
        }

        my $bits = $modebits & $S_MMASK;
        my $typ = 0;
        $typ = 1 if ($mode & $S_ISDIR) == $S_ISDIR;
        $typ = 2 if ($mode & $S_ISLNK) == $S_ISLNK;
        print STDERR "$path\n" if $verbose;

        my $match = 0;
        if ($dump eq '+') {        # add
                if ($path =~ /$REG/) {
                        $match = 1;
                }

                if ($invert) {
                        $match = ! $match;
                }

                if ($typ == 0) {      # REG
                        if ($match == 1) {
                                # match
                                if ($fsize != 0 and $remote) {
                                        syswrite STDOUT, "$dump$modebits $uid $gid $psize $fsize\n$path";
                                        copy($fsize, *STDOUT);
                                } else {      # No content
                                        syswrite STDOUT, "$dump$modebits $uid $gid $psize $fsize\n$path";
                                }
                        }
                } elsif ($typ == 1) {      # DIR
                        if ($match == 1) {
                                syswrite STDOUT, "$dump$modebits $uid $gid $psize $fsize\n$path";
                        }
                } elsif ($typ == 2) {      # LNK
                        my $target;
                        read STDIN, $target, $fsize;
                        if ($match == 1) {
                                syswrite STDOUT, "$dump$modebits $uid $gid $psize $fsize\n$path$target";
                        }
                }
        } else {
                if ($match == 1) {
                        syswrite STDOUT, "$dump$modebits $uid $gid $psize $fsize\n$path";
                }
        }
}

sub usage {
        print "$progName [OPTIONS] REGEXP\n\n";
        print "Grep rdup's output using REGEXP\n\n";
        print "OPTIONS:\n";
        print " -c    also process the files' content (rdup -c)\n";
        print " -i    invert, print all what doesn't match\n";
        print " -v    echo the files process to standard error\n";
        print " -h    this help\n";
        print " -V    print version\n";
        exit;
}

sub version {
        print "$progName: @PACKAGE_VERSION@ (rdup-utils)\n";
        exit;
}


sub sanity_check {
        my $dump = $_[0];
        my $mode = $_[1];
        my $psize = $_[2];
        my $fsize = $_[3];
        my $uid = $_[4];
        my $gid = $_[5];

        die "** $progName: dump must be + or -"   if $dump ne "+" && $dump ne "-";
        die "** $progName: mode must be numeric"  unless $mode =~ "[0-9]+";
        die "** $progName: psize must be numeric" unless $psize =~ "[0-9]+";
        die "** $progName: fsize must be numeric" unless $fsize =~ "[0-9]+";
        die "** $progName: uid must be numeric"   unless $uid =~ "[0-9]+";
        die "** $progName: gid must be numeric"   unless $gid =~ "[0-9]+";
}

sub copy {
        my $count = $_[0];
        my $pipe = $_[1];

        my $buf;
        my $n;

        while ($count > 4096) {
                $n = read STDIN, $buf, 4096;
                syswrite $pipe, $buf, $n;
                $count -= 4096;
        }
        if ($count > 0) {
                $n = read STDIN, $buf, $count;
                syswrite $pipe, $buf, $n;
        }
}

sub cat {
        my $file = $_[0];

        my $buf;
        my $n;

        while (($n = read $file, $buf, 4096) > 0) {
                syswrite STDOUT, $buf, $n;
        }
}

sub catfile {
        my $name = $_[0];
        open FILE, "<$name" or die "** $name: $!";
        cat(*FILE);
        close FILE;
}
