#!/bin/bash
#
# Copyright (c) 2005, 2006 Miek Gieben
# See LICENSE for the license
#
# throw is used to generate a output from
# rdup that is suitable for giving to 
# catch.sh. Catch can be run on a remote host
# It transforms rdup out from
# +/-MODE UID GID FILESIZE PATH 
# to 
# +/-MODE UID GID FILESIZE PATHSIZE\nPATH FILECONTENTS
# any zipping should be handled by the network protcol
# encryption of file contents should be possible as
# long as the filesize does not change!

. @sysconfdir@/rdup/shared.sh

backup_defines
backup_cmd_options $@

if [[ ! -f $keyfile ]]; then
        echo "** Can not open key file"
        exit 1
fi

alg="blowfish"

declare -a path # catch spacing in the path
while read mode uid gid size path
do
        dump=${mode:0:1}        # to add or remove
        mode=${mode:1}          # st_mode bits
        bits=$(($mode & $S_MMASK)) # permission bits
        bits=`printf "%o" $bits` # and back to octal again
        typ=0
        if [[ $(($mode & $S_ISDIR)) == $S_ISDIR ]]; then
                typ=1;
        fi
        if [[ $(($mode & $S_ISLNK)) == $S_ISLNK ]]; then
                typ=2;
        fi
        
        if [[ $dump == "+" ]]; then
                # add
                case $typ in
                        0)      # reg file
                        echo -e "+$mode $uid $gid $size ${#path}\n$path"
                        # do your encryption here
                        if [[ ! -z $keyfile  ]]; then
                                mcrypt -F -k "$keyfile" -a "$alg" --mode stream "$path"
                        else
                                cat "$path"
                        fi
                        ;;
                        1)      # directory
                        echo -e "+$mode $uid $gid 0 ${#path}\n$path"
                        ;;
                        2)      # link, yuch... write the target of the link in the filecontents
                        LS_OUT=$(ls -l "$path")
                        target=${LS_OUT#*-> }
                        echo -e "+$mode $uid $gid ${#target} ${#path}\n$path"
                        echo -n "$target"
                        ;;
                esac
        else
                # remove, $size should be 0
                echo -e "-$mode $uid $gid 0 ${#path}\n$path"
        fi
done 
